---
title: "Thesis Chapter Logger Data"
author: "Chance Yan"
date: "2024-12-18"
output: word_document
editor_options: 
  chunk_output_type: console
---

## Body Temperature Data R Markdown File Data Results

I am currently processing data for my 1st chapter of my thesis; however, this presentation will focus on logger data and body temperatures rather than heart rate data. As previously discussed between Brian and I, it may be beneficial to write up and publish the logger data temperatures to support the heart rate data. Thus the following will be a report on the logger data.

Introduction:

As many know, environmental temperatures are rising. This will surely have consequences on all biological animals as temperature is considered the "master factor". Many climate models have predicted temperature increases which has significant meaning towards the animals living in those temperature elevated environments. However, it's still unknown how those elevated temperatures will affect the animals living in said environments.

Many previous studies have tested the thermal limits of animals to test how they might respond under these elevated temperatures. While understanding the thermal limits of animals is important to predicting how elevated temperatures will affect them, it doesn't tell the whole story. It is still unknown what temperature the animal experiences in the environment. For example, an animal's thermal limit may be above predicted thermal predictions, but it only experiences cold temperatures due to behaviors or physiological mechanisms. To understand what animals experience in their environment, many studies have used environmental loggers to record temperatures for their study environment. While these loggers provide useful information about what temperatures these animals may experience it does not tell us what temperatures they are experiencing. It may be possible that using these environmental loggers to estimate temperatures that the animals experience may be inaccurate.

Specifically, the intertidal is very spatially diverse and high heterogeneity. Assuming air temperature or logger temperature is equivalent to body temperature of animals in the intertidal may result in false conclusions about your study system.

Methods:

Here we used environmental temperature loggers and body temperature from 5 different species to test if logger temperature data can be used as an estimate to animal body temperature in the marine intertidal.

We installed Electric Blue Environmental Loggers at different sites in Cape Ann. We used two different sites to compare topographic affects, site direction, and site location on site temperature. At each site, there was 3 loggers for each zone in the intertidal (upper, middle, and lower). Within each tidal height, we installed 2 loggers in a niche space that we saw animals occupying. The third logger was installed in the open.

The amount of Loggers was placed as followed:

```{r}
loggers <- data.frame(lower = c("3", "3"), middle = c("3", "3"), upper = c("3", "3"), site = c("Loblolly", "Seaside"))
require("knitr")
kable(loggers)
```

To compare environmental temperatures to animal temperatures we used grab and stab to take body temperatures of animals. When the conditions were met, we would go sample animal body temperature. We measured a max of 15 in each intertidal zone along a transect line. For Mytilus we only measured 5 of each due to lack of animals to use.

Conditions for Field Day:
-Low tide fell between 1-4 PM
-Low tide was below 2 feet
-Not rainy

```{r, include = FALSE}
library(ggplot2)
library(patchwork)
library(tidyverse)
library(quantmod)
library(dplyr)
library(ggrepel) 
library(readxl)
library(bayesbio)
library(car)


opts_knit$set(root.dir = "~/Documents/R/BodyTempData")
setwd("~/Documents/R/BodyTempData")
body_temps <- read_excel("BodyTemperatures.xlsx")
flat_temps <- read_excel("FlatlineTemperatures.xlsx")

body_temps$Species <- factor(body_temps$Species, levels = c("NL", "ME", "LO" , "LS", "LL"))
body_temps$tsm <- NA
body_temps$tsm <- ifelse(body_temps$Species == "NL", (35.76200-body_temps$temp), body_temps$tsm)
body_temps$tsm <- ifelse(body_temps$Species == "LL", (40.63357-body_temps$temp), body_temps$tsm)
body_temps$tsm <- ifelse(body_temps$Species == "LS", (39.355-body_temps$temp), body_temps$tsm)
body_temps$tsm <- ifelse(body_temps$Species == "LO", (40.14583-body_temps$temp), body_temps$tsm)
body_temps$tsm <- ifelse(body_temps$Species == "ME", (37.228-body_temps$temp), body_temps$tsm)

fulldata <- list.files(pattern = ".csv") 
names <- vector()
Etemp = data.frame()

#storing variables in a dataframe in a list
for(i in 1:length(fulldata)){
  Etemp <- c(Etemp, list(read.csv(fulldata[i])))
  names <- c(names, fulldata[i])
}

#Covert all time formats to correct formats
for(i in 1:length(fulldata)){
  DF <-strptime(Etemp[[i]]$time,format="%m/%d/%y %H:%M")
  Etemp[[i]]$time<-as.POSIXct(DF,format="%Y-%m-%d%H:%M")
}

#setting time zone to EST
hrs <- hours(5) 
for(i in 1:length(fulldata)){
  Etemp[[i]]$time <- Etemp[[i]]$time - hrs
}

#Creating overview plot
ggplot(body_temps, aes(Species, tsm))+geom_boxplot()+facet_wrap(~NicheSpace)+ggtitle("Thermal safety margins of each species in each Niche Space")+geom_hline(yintercept = 0, color = "red")

names

sites <- c("loblolly", "loblolly", "loblolly", "loblolly", "loblolly", "loblolly", "loblolly", "loblolly", "seaside", "seaside", "seaside", "seaside", "seaside", "seaside", "seaside", "seaside", "seaside")
Niches <- c("crevice", "open", "vertical", "crevice", "open", "crevice",
            "open", "seaweed", "crevice", "open", "vertical", "crevice",
            "open", "seaweed", "crevice", "open", "seaweed")
Tides <- c("upper", "upper", "upper", "lower", "lower", "middle",
           "middle", "middle", "upper", "upper", "upper", "lower",
           "lower", "lower", "middle", "middle", "middle")

r.value <- c()
logger.name <- c()
species.name <- c()
total.count <- c()
sig.track <- c()
p.value <- c()
#via t-test
over.under <- c()
avg <- c()

for(i in 1:17){
    #GRAPING animal body temperatures against logger temperatures for their respective niche and tide height and site and time
    #sepparating data to comepare animals found in certain areas to their respective temperature logger
    subDF <- subset(body_temps, body_temps$Tide == Tides[i] & body_temps$NicheSpace == Niches[i] & body_temps$Site == sites[i])
    #remove all columns in the dataset
    subDF <- data.frame(subDF$time, subDF$temp, subDF$Species)
    colnames(subDF)[1] ="time"
    colnames(subDF)[2] ="temp"
    colnames(subDF)[3] ="species"
    #combine both environmental temperatures and body temperatures by time and date
    #then graph them by temperatures
    combined <- nearestTime(subDF, Etemp[[i]], "time", "time")
    colnames(combined)[4] = "EnvironmentTemperature"
    colnames(combined)[2] = "BodyTemperature"
    
    LO <- subset(combined, species == "LO")
    LL <- subset(combined, species == "LL")
    NL <- subset(combined, species == "NL")
    LS <- subset(combined, species == "LS")
    ME <- subset(combined, species == "ME")
    
    #going through each species
    for(a in 1:5){
      
      animal.name = NA
      s.name = NA
      
      if(a == 1){
        animal.name = LO
        s.name = "LO"
      }
      else if(a == 2){
        animal.name = LL
        s.name = "LL"
      }
      else if(a == 3){
        animal.name = NL
        s.name = "NL"
      }
      else if(a == 4){
        animal.name = LS
        s.name = "LS"
      }
      else{
        animal.name = ME
        s.name = "ME"
      }
      
      if(nrow(animal.name) > 10){
        lm.temp <- lm(animal.name$EnvironmentTemperature~animal.name$BodyTemperature)
        r.value <- c(r.value, summary(lm.temp)$r.squared)
        logger.name <- c(logger.name, names[i])
        species.name <- c(species.name, s.name)
        total.count <- c(total.count, length(animal.name$BodyTemperature))
        c.test <- cor.test(animal.name$EnvironmentTemperature, animal.name$BodyTemperature, method = "pearson")
        
        dif.list <- c()
        average <- c()
        
        for(j in 1:nrow(animal.name)){
          dif.list <- c(dif.list, (animal.name$BodyTemperature[j] - animal.name$EnvironmentTemperature[j]))
          average <- c(average, (animal.name$BodyTemperature[j] - animal.name$EnvironmentTemperature[j]))
        }
      
        ttest <- t.test(dif.list, mu = 0)
        over.under <- c(over.under, ttest$p.value)
        average <- mean(average)
        avg <- c(avg, average)
      
        if(c.test$p.value <= 0.05){
          sig.track <- c(sig.track, "yes")
          
          #nameBody <- paste("Hist of ", s.name, " Body Temp")
          #nameEnv <- paste("Hist of ", s.name, " ENV Temp")
          
          #print(ggplot(animal.name, aes(animal.name$BodyTemperature)) + 
          #  geom_histogram(binwidth=1) +
          #  ggtitle(nameBody))
          
          #print(qqPlot(animal.name$BodyTemperature))
          
          #print(ggplot(animal.name, aes(animal.name$EnvironmentTemperature)) + 
          #        geom_histogram(binwidth=1) +
          #        ggtitle(nameEnv))
          
          #print(qqPlot(animal.name$EnvironmentTemperature))
        }
        else{
          sig.track <- c(sig.track, "no")
        }
        p.value <- c(p.value, c.test$p.value)
    }
    else{
      average <- c()
      r.value <- c(r.value, NA)
      logger.name <- c(logger.name, names[i])
      species.name <- c(species.name, s.name)
      total.count <- c(total.count, length(animal.name$BodyTemperature))
      sig.track <- c(sig.track, NA)
      p.value <- c(p.value, NA)
      over.under <- c(over.under, NA)
      
      
      for(j in 1:nrow(animal.name)){
        average <- c(average, (animal.name$BodyTemperature[j] - animal.name$EnvironmentTemperature[j]))
      }
      average <- mean(average)
      avg <- c(avg, average)
    }
  }
}
```

To analyze the data, I matched body temperatures to logger temperatures that were taken at the time we had collected. More specifically, animal body temperatures were matched to logger temperatures that were at the same tidal height and niche space. After matching, I ran a correlation test between the body temperature and logger temperature and I created a heat map between logger and body temperature filling with the p-value from the correlation test (using Pearson's test). Tests were only ran if there were above 10 data points in the respective category. 

I also created another heat map that is filled with the difference between body temperature and logger temperature. I calculated it with body temperature - logger temperature. Therefore if the value is positive we might assume body temperature is greater and loggers are underestimating animal temperatures. However, if we see the value is negative, then logger temperatures are greater and they are overestimating animal temperatures.

```{R echo = FALSE}
heat_data <- data.frame(r.value, logger.name, species.name, total.count, sig.track, p.value, over.under, avg)
man_data <- heat_data
for(i in 1:nrow(man_data)){
  if(is.na(heat_data[i,7])){
    man_data[i, 8] <- NA
  }
  man_data$avg[i] <- round(man_data$avg[i], digits=2)
}

ggplot(man_data, aes(species.name, logger.name, fill = sig.track)) + 
  geom_tile() +
  ggtitle("Heat map of P-values matching logger temperatures to species temperatures") +
  geom_text(aes(label = total.count), color = "black", size = 3)

ggplot(man_data, aes(species.name, logger.name, fill= avg)) + 
  geom_tile() +
  theme_classic() +
  ggtitle("Heat map of Body Temperature Differences to Logger Temperatures")+
  geom_text(aes(label = avg), color = "red", size = 3)
```

Results:

-   From the heat map that was filled with P values, we see that only 6 out of 31 loggers gave stastically significant correlated estimates between logger and body temperatures.

-   Out of those 6 loggers, 5 of are positive values meanwhile the logger that is negative sits at -11 and is Loblolly High Open for Littorea

Conclusions:

-   It seems that not many body temperatures correlate with logger temperatures, so we might infer that just placing logger temperatures is not enough to estimate what temperatures animals experience in the field.

-   We also can see from the second heat map, values tend to be more positive (in non upper intertidal zones), so loggers in the middle and lower intertidal zones tend to underestimate animal body temperature while loggers in the upper intertidal zone tend to overestimate animal body temperature.

-   This can have major implications to have thermal limit studies interpret their results. No other study has directly compared the marine intertidal community with body temperature and logger temperatures to see if they correlate. By using logger temperatures to estimate what animals experience in the field (and using that value to calculate thermal safety margins or warming tolerances) it may give over or underestimates of the situation.

Additionals:

-   I created normal distributions for body temperatures and logger temperatures along with qqplots to test for normalitity

-   I also graphed out the days we collected and highlighted the collection times to show that we measured body temperature at the highest peaks of the day. This illustrates that logger temperatures may be inaccurate when temperatures peak (most important)
